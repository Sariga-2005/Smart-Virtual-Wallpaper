<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Wallpaper Preview</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2em;
            text-align: center;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
            text-align: center;
        }

        .upload-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .upload-box {
            border: 3px dashed #ddd;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s;
            background: #f9f9f9;
        }

        .upload-box:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .upload-box h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .upload-box p {
            color: #666;
            margin-bottom: 20px;
            font-size: 0.9em;
        }

        .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            cursor: pointer;
            transition: transform 0.2s;
            display: inline-block;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
        }

        .upload-btn.secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        input[type="file"] {
            display: none;
        }

        .work-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .canvas-box {
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 20px;
            background: #fafafa;
        }

        .canvas-box h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .canvas-wrapper {
            position: relative;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            cursor: crosshair;
        }

        canvas {
            display: block;
            width: 100%;
            height: auto;
        }

        .instruction {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #856404;
        }

        .instruction strong {
            display: block;
            margin-bottom: 5px;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 10px;
        }

        .control-group label {
            display: block;
            color: #333;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.9em;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
        }

        .value-display {
            color: #667eea;
            font-weight: bold;
            margin-top: 5px;
            font-size: 0.9em;
        }

        .actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            font-size: 1.1em;
            padding: 15px 40px;
        }

        .btn-success:hover {
            transform: scale(1.05);
        }

        .btn-finish {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            font-size: 1em;
            padding: 12px 30px;
        }

        .btn-finish:hover {
            transform: scale(1.05);
        }

        .btn-warning {
            background: #ff9800;
            color: white;
        }

        .btn-warning:hover {
            background: #e68900;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            font-weight: 600;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .upload-grid, .work-area {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé® Smart Wallpaper Preview</h1>
        <p class="subtitle">Select wall area and apply wallpaper pattern realistically</p>

        <div class="upload-grid">
            <div class="upload-box">
                <h3>Step 1: Upload Room Photo</h3>
                <p>Upload an image of your room with the wall</p>
                <label for="wallInput" class="upload-btn">
                    üì∑ Choose Room Image
                </label>
                <input type="file" id="wallInput" accept="image/*">
            </div>

            <div class="upload-box">
                <h3>Step 2: Upload Wallpaper Pattern</h3>
                <p>Upload the wallpaper design/pattern</p>
                <label for="patternInput" class="upload-btn secondary">
                    üé® Choose Wallpaper Pattern
                </label>
                <input type="file" id="patternInput" accept="image/*">
            </div>
        </div>

        <div class="instruction" id="instruction" style="display:none;">
            <strong>üìç Step 3: Select Wall Area</strong>
            Click around the edges of your wall to mark the area (minimum 3 points). Click as many points as needed to trace your wall precisely. When done, click "Finish Selection" button.
        </div>

        <div class="controls" style="display:none;" id="controlsPanel">
            <div class="control-group">
                <label for="scaleRange">Pattern Size</label>
                <input type="range" id="scaleRange" min="0.02" max="1.0" step="0.01" value="0.25">
                <div class="value-display" id="scaleValue">0.25x</div>
            </div>

            <div class="control-group">
                <label for="opacityRange">Pattern Opacity</label>
                <input type="range" id="opacityRange" min="60" max="100" step="5" value="95">
                <div class="value-display" id="opacityValue">95%</div>
            </div>

            <div class="control-group">
                <label for="brightnessRange">Brightness</label>
                <input type="range" id="brightnessRange" min="80" max="120" step="5" value="100">
                <div class="value-display" id="brightnessValue">100%</div>
            </div>

            <div class="control-group">
                <label for="blendMode">Blend Mode</label>
                <select id="blendMode" style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ddd; font-size: 0.9em;">
                    <option value="source-over">Normal (Cover)</option>
<option value="multiply" selected>Multiply (Realistic)</option>
<option value="overlay">Overlay</option>
<option value="soft-light">Soft Light</option>

                </select>
            </div>
        </div>

        <div class="work-area" id="workArea" style="display:none;">
            <div class="canvas-box">
                <h3>Room Image - Click to trace wall outline</h3>
                <div class="canvas-wrapper">
                    <canvas id="sourceCanvas"></canvas>
                </div>
                <div class="actions">
                    <button class="btn btn-finish" id="finishBtn" style="display:none;">‚úì Finish Selection</button>
                    <button class="btn btn-warning" id="resetPoints">Reset Points</button>
                    <button class="btn btn-success" id="applyBtn" style="display:none;">‚ú® Apply Wallpaper</button>
                </div>
                <p style="text-align: center; color: #666; margin-top: 10px; font-size: 0.9em;" id="pointCount">Points selected: 0</p>
            </div>

            <div class="canvas-box">
                <h3>Result Preview</h3>
                <div class="canvas-wrapper">
                    <canvas id="resultCanvas"></canvas>
                </div>
                <div class="actions">
                    <button class="btn btn-secondary" id="resetBtn">Reset Settings</button>
                    <button class="btn btn-primary" id="downloadBtn">Download Result</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const HD_MULTIPLIER = 3;

        const wallInput = document.getElementById('wallInput');
        const patternInput = document.getElementById('patternInput');
        const sourceCanvas = document.getElementById('sourceCanvas');
        const resultCanvas = document.getElementById('resultCanvas');
        const srcCtx = sourceCanvas.getContext('2d');
        const resCtx = resultCanvas.getContext('2d');
        const workArea = document.getElementById('workArea');
        const instruction = document.getElementById('instruction');
        const controlsPanel = document.getElementById('controlsPanel');
        const applyBtn = document.getElementById('applyBtn');
        const resetPoints = document.getElementById('resetPoints');
        const finishBtn = document.getElementById('finishBtn');
        const resetBtn = document.getElementById('resetBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const pointCount = document.getElementById('pointCount');

        const scaleRange = document.getElementById('scaleRange');
        const opacityRange = document.getElementById('opacityRange');
        const brightnessRange = document.getElementById('brightnessRange');
        const blendMode = document.getElementById('blendMode');

        let wallImg = new Image();
        let patternImg = new Image();
        let hasWall = false;
        let hasPattern = false;
        let points = [];
        let canvasScale = 1;
        let selectionFinished = false;

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            if (type === 'error') {
                notification.style.background = '#f44336';
            }
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 2500);
        }

        wallInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                wallImg.onload = function() {
                    setupCanvas();
                    hasWall = true;
                    checkReady();
                    showNotification('Room image uploaded! üì∑');
                };
                wallImg.src = url;
            }
        });

        patternInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                patternImg.onload = function() {
                    hasPattern = true;
                    checkReady();
                    showNotification('Wallpaper pattern uploaded! üé®');
                };
                patternImg.src = url;
            }
        });

        function setupCanvas() {
            const maxWidth = 600;
            canvasScale = maxWidth / wallImg.width;
            sourceCanvas.width = wallImg.width * canvasScale;
            sourceCanvas.height = wallImg.height * canvasScale;
            resultCanvas.width = sourceCanvas.width;
            resultCanvas.height = sourceCanvas.height;
            
            drawSource();
        }

        function drawSource() {
            srcCtx.clearRect(0, 0, sourceCanvas.width, sourceCanvas.height);
            srcCtx.drawImage(wallImg, 0, 0, sourceCanvas.width, sourceCanvas.height);
            
            // Draw points
            points.forEach((point, i) => {
                srcCtx.fillStyle = '#ff0000';
                srcCtx.beginPath();
                srcCtx.arc(point.x, point.y, 6, 0, Math.PI * 2);
                srcCtx.fill();
                
                // Draw point number
                srcCtx.fillStyle = 'white';
                srcCtx.font = 'bold 12px Arial';
                srcCtx.textAlign = 'center';
                srcCtx.textBaseline = 'middle';
                srcCtx.fillText(i + 1, point.x, point.y);
            });

            // Draw lines connecting points
            if (points.length > 1) {
                srcCtx.strokeStyle = '#ff0000';
                srcCtx.lineWidth = 2;
                srcCtx.setLineDash([5, 5]);
                srcCtx.beginPath();
                srcCtx.moveTo(points[0].x, points[0].y);
                for (let i = 1; i < points.length; i++) {
                    srcCtx.lineTo(points[i].x, points[i].y);
                }
                srcCtx.stroke();
                srcCtx.setLineDash([]);
            }

            // Draw closing line if selection is finished
            if (selectionFinished && points.length >= 3) {
                srcCtx.strokeStyle = '#00ff00';
                srcCtx.lineWidth = 3;
                srcCtx.beginPath();
                srcCtx.moveTo(points[0].x, points[0].y);
                for (let i = 1; i < points.length; i++) {
                    srcCtx.lineTo(points[i].x, points[i].y);
                }
                srcCtx.closePath();
                srcCtx.stroke();
                
                // Fill with semi-transparent overlay
                srcCtx.fillStyle = 'rgba(0, 255, 0, 0.1)';
                srcCtx.fill();
            }
        }

        function checkReady() {
            if (hasWall && hasPattern) {
                workArea.style.display = 'grid';
                instruction.style.display = 'block';
                controlsPanel.style.display = 'grid';
            }
        }

        sourceCanvas.addEventListener('click', (e) => {
            if (selectionFinished) return;
            
            const rect = sourceCanvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (sourceCanvas.width / rect.width);
            const y = (e.clientY - rect.top) * (sourceCanvas.height / rect.height);
            
            points.push({x, y});
            drawSource();
            
            pointCount.textContent = `Points selected: ${points.length}`;
            
            if (points.length >= 3) {
                finishBtn.style.display = 'inline-block';
            }
        });

        finishBtn.addEventListener('click', () => {
            if (points.length < 3) {
                showNotification('Please select at least 3 points!', 'error');
                return;
            }
            selectionFinished = true;
            finishBtn.style.display = 'none';
            applyBtn.style.display = 'inline-block';
            drawSource();
            showNotification(`Selection finished with ${points.length} points! Click Apply Wallpaper`);
        });

        resetPoints.addEventListener('click', () => {
            points = [];
            selectionFinished = false;
            drawSource();
            applyBtn.style.display = 'none';
            finishBtn.style.display = 'none';
            pointCount.textContent = 'Points selected: 0';
            showNotification('Points reset! Click to trace wall again');
        });
function applyWallpaper() {
    if (points.length < 3 || !selectionFinished) return;

    // Clear & redraw base image
    resCtx.clearRect(0, 0, resultCanvas.width, resultCanvas.height);
    resCtx.drawImage(wallImg, 0, 0, resultCanvas.width, resultCanvas.height);

    const scale = parseFloat(scaleRange.value);
    const tileW = Math.round(patternImg.width * scale);
    const tileH = Math.round(patternImg.height * scale);

    // ---- CLIP WALL POLYGON ----
    resCtx.save();
    resCtx.beginPath();
    resCtx.moveTo(points[0].x, points[0].y);
    for (let i = 1; i < points.length; i++) {
        resCtx.lineTo(points[i].x, points[i].y);
    }
    resCtx.closePath();
    resCtx.clip();

    // ---- EFFECTS ----
    resCtx.globalAlpha = opacityRange.value / 100;
    resCtx.globalCompositeOperation = blendMode.value;
    resCtx.filter = `brightness(${brightnessRange.value}%)`;

    // ---- MANUAL TILE DRAWING (NO GAPS EVER) ----
    for (let y = -tileH; y < resultCanvas.height + tileH; y += tileH) {
        for (let x = -tileW; x < resultCanvas.width + tileW; x += tileW) {
            resCtx.drawImage(patternImg, x, y, tileW, tileH);
        }
    }

    // ---- RESET STATE ----
    resCtx.restore();
    resCtx.filter = 'none';
    resCtx.globalAlpha = 1;
    resCtx.globalCompositeOperation = 'source-over';
}



        applyBtn.addEventListener('click', applyWallpaper);

        function updateValueDisplays() {
            document.getElementById('scaleValue').textContent = scaleRange.value + 'x';
            document.getElementById('opacityValue').textContent = opacityRange.value + '%';
            document.getElementById('brightnessValue').textContent = brightnessRange.value + '%';
        }

        scaleRange.addEventListener('input', () => {
            updateValueDisplays();
            if (points.length >= 3 && selectionFinished) applyWallpaper();
        });

        opacityRange.addEventListener('input', () => {
            updateValueDisplays();
            if (points.length >= 3 && selectionFinished) applyWallpaper();
        });

        brightnessRange.addEventListener('input', () => {
            updateValueDisplays();
            if (points.length >= 3 && selectionFinished) applyWallpaper();
        });

        blendMode.addEventListener('change', () => {
            if (points.length >= 3 && selectionFinished) applyWallpaper();
        });

        resetBtn.addEventListener('click', () => {
    // Reset UI values
    scaleRange.value = 0.25;
    opacityRange.value = 95;
    brightnessRange.value = 100;
    blendMode.value = 'multiply';

    updateValueDisplays();

    // Reapply wallpaper ONLY if selection is valid
    if (points.length >= 3 && selectionFinished) {
        applyWallpaper();
        showNotification('Preset settings applied ‚úÖ');
    } else {
        showNotification('Select wall and apply wallpaper first', 'error');
    }
});


        downloadBtn.addEventListener('click', () => {
    if (points.length < 3 || !selectionFinished) {
        showNotification('Please apply wallpaper first!', 'error');
        return;
    }

    const hdCanvas = document.createElement('canvas');
    hdCanvas.width = resultCanvas.width * HD_MULTIPLIER;
    hdCanvas.height = resultCanvas.height * HD_MULTIPLIER;

    const hdCtx = hdCanvas.getContext('2d');
    hdCtx.scale(HD_MULTIPLIER, HD_MULTIPLIER);

    // draw EXACT preview into HD canvas
    hdCtx.drawImage(resultCanvas, 0, 0);

    const link = document.createElement('a');
    link.download = 'wallpaper-hd.png';
    link.href = hdCanvas.toDataURL('image/png');
    link.click();

    showNotification('HD image downloaded üì•');
});


        updateValueDisplays();
    </script>
</body>
</html>